# 备份还原功能改进说明

## 概述

本次更新改进了备份还原功能，增加了更灵活的导出方式和从外部应用导入备份文件的能力。

## 新增功能

### 1. 导出并分享

**主要按钮**：点击"导出并分享"按钮可以将备份文件通过系统分享功能分享到其他应用。

**使用场景**：
- 分享到云存储应用（如百度网盘、阿里云盘、OneDrive等）
- 通过即时通讯软件（如微信、QQ、钉钉）发送给其他人
- 通过邮件发送备份文件
- 保存到任何支持接收文件的应用

**技术实现**：
- 使用 `share_plus` 包实现跨平台分享
- 文件保存到临时目录后通过系统分享面板分享
- 支持 Android、iOS、Web、Windows、macOS、Linux

### 2. 保存到指定目录

**按钮位置**：左侧辅助按钮

**功能说明**：
- **移动端/Web**：使用系统文件选择器（FileSaver），让用户选择保存位置
- **桌面端**：打开目录选择对话框，用户可以选择任意目录保存文件

**使用场景**：
- 想要将备份保存到特定文件夹
- 桌面端用户想要自己管理备份文件位置
- 需要固定的备份保存位置便于查找

### 3. 复制到剪切板

**按钮位置**：右侧辅助按钮

**功能说明**：将备份JSON直接复制到剪切板，可以粘贴到任何地方（如笔记应用、文本编辑器）

**使用场景**：
- 快速备份小量数据
- 临时保存配置
- 在不同设备间快速传输配置

### 4. 从外部应用导入

**新增能力**：应用现在可以接收从其他应用分享的备份文件

**支持的方式**：
1. **文件管理器**：在文件管理器中找到备份文件，点击"分享"或"打开方式"，选择本应用
2. **云存储应用**：从云存储应用（如网盘）中分享备份文件到本应用
3. **即时通讯**：接收好友发送的备份文件后，分享到本应用

**工作流程**：
1. 其他应用分享 `.txt` 或 `.json` 文件到本应用
2. 应用自动打开并弹出确认对话框
3. 确认后，文件内容自动填充到还原文本框
4. 检查内容无误后点击"开始还原"按钮

**Android配置**：
- 应用已注册 `android.intent.action.SEND` 和 `android.intent.action.VIEW` Intent Filter
- 支持 `text/*` 和 `*/*` MIME类型
- 支持打开 `.txt` 和 `.json` 文件

**iOS配置**：
- 在 `Info.plist` 中声明支持的文档类型
- 支持 `public.plain-text` 和 `public.json` 内容类型
- 启用了文档浏览器支持

## 技术细节

### 依赖包

新增了以下依赖：
```yaml
# 分享功能
share_plus: ^10.1.3

# 接收其他app分享的文件
receive_sharing_intent: ^1.8.1
```

### 主要修改的文件

1. **lib/core/backup/pages/backup_restore_page.dart**
   - 修改了导出按钮布局和功能
   - 新增 `_exportAndShare()` 方法
   - 新增 `_exportToSelectedDirectory()` 方法
   - 新增 `_checkSharedFile()` 和 `_loadSharedFile()` 方法处理外部分享

2. **lib/main.dart**
   - 将 `MyApp` 改为 `StatefulWidget`
   - 添加分享意图监听
   - 新增 `SharedFileImportService` 单例服务

3. **android/app/src/main/AndroidManifest.xml**
   - 添加 Intent Filters 接收分享和文件打开请求

4. **ios/Runner/Info.plist**
   - 添加 `CFBundleDocumentTypes` 声明支持的文件类型
   - 启用文档浏览器和就地打开支持

### 架构设计

**SharedFileImportService**：
- 单例模式
- 用于在 main.dart 和 backup_restore_page 之间传递分享的文件路径
- 避免使用全局变量，保持代码整洁

**平台差异处理**：
```dart
if (kIsWeb || Platform.isAndroid || Platform.isIOS) {
  // 移动端和Web：使用 FileSaver
} else {
  // 桌面端：使用目录选择器
}
```

## 用户指南

### 如何导出备份

1. 打开"备份与还原"页面
2. 选择导出方式：
   - **推荐**：点击"导出并分享"，选择要分享到的应用
   - 或点击"保存到指定目录"，选择保存位置
   - 或点击"复制到剪切板"，然后粘贴到其他地方

### 如何从文件导入

#### 方法1：通过文件管理器
1. 在文件管理器中找到备份文件（`.txt` 或 `.json`）
2. 长按文件，选择"分享"或"打开方式"
3. 选择"生活工具箱"或"小蜜"应用
4. 确认导入

#### 方法2：通过云存储应用
1. 在云存储应用（如百度网盘、阿里云盘）中找到备份文件
2. 点击"分享"或"发送到其他应用"
3. 选择"生活工具箱"应用
4. 确认导入

#### 方法3：接收好友分享
1. 好友通过微信、QQ等发送备份文件
2. 下载或保存文件
3. 在聊天窗口中长按文件，选择"用其他应用打开"
4. 选择"生活工具箱"应用
5. 确认导入

#### 方法4：传统方式
1. 打开"备份与还原"页面
2. 点击"从 TXT 文件导入"按钮
3. 在文件选择器中找到并选择备份文件
4. 检查内容后点击"开始还原"

## 测试建议

### 导出功能测试
1. 测试"导出并分享"功能，验证分享面板是否正常弹出
2. 测试"保存到指定目录"功能：
   - Android：验证系统文件选择器
   - 桌面端：验证目录选择对话框
3. 测试"复制到剪切板"功能，验证是否可以粘贴

### 导入功能测试
1. 从文件管理器分享文件到应用
2. 从云存储应用分享文件到应用
3. 验证错误处理（如分享非JSON文件）
4. 验证文件内容自动填充到文本框
5. 验证还原功能正常工作

### 跨平台测试
- [ ] Android 手机
- [ ] iOS 手机
- [ ] Windows 桌面
- [ ] macOS 桌面
- [ ] Linux 桌面
- [ ] Web 浏览器

## 注意事项

1. **备份文件安全**：备份文件包含 API Key 等敏感信息，请妥善保管
2. **文件格式**：确保导入的文件是有效的 JSON 格式
3. **还原前备份**：在还原前建议先导出当前数据作为备份
4. **网络分享**：通过网络分享备份文件时注意数据安全
5. **临时文件**：分享功能使用的临时文件会在系统清理时自动删除

## 未来改进方向

- [ ] 支持加密备份文件
- [ ] 支持增量备份
- [ ] 支持自动备份到云存储
- [ ] 支持备份历史版本管理
- [ ] 支持选择性还原（只还原部分数据）
